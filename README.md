# โปรเจกต์เฟิร์มแวร์หุ่นยนต์ Mecanum 4 ล้อ

## ภาพรวม

โปรเจกต์นี้ประกอบด้วยเฟิร์มแวร์สำหรับควบคุมหุ่นยนต์ที่ใช้ล้อ Mecanum จำนวน 4 ล้อ โดยใช้บอร์ดไมโครคอนโทรลเลอร์ในตระกูล STM32 (เช่น Bluepill หรือ Blackpill) และควบคุมผ่านรีโมทคอนโทรล FlySky i6

มีโปรแกรมหลักให้เลือกใช้ 3 เวอร์ชัน ตามความต้องการในการควบคุม:

1.  **`DirecControlV3.ino`** - การควบคุมโดยตรง (Open-loop)
2.  **`SimpleFeedbackControlV3.ino`** - การควบคุมแบบป้อนกลับอย่างง่าย (Simple Closed-loop)
3.  **`PID_Control_V3.ino`** - การควบคุมด้วย PID Controller (Advanced Closed-loop)

## คำอธิบายโปรแกรม

### 1. `DirecControlV3.ino` (ควบคุมตรง)

เป็นเวอร์ชันพื้นฐานที่สุด เหมาะสำหรับการทดสอบฮาร์ดแวร์ เช่น มอเตอร์, ไดรเวอร์, และการเชื่อมต่อรีโมท

**หลักการทำงาน:**
*   อ่านค่าจาก Joystick ของรีโมท
*   แปลงค่าเป็นสัญญาณ PWM โดยตรงเพื่อสั่งงานมอเตอร์
*   ไม่มีการใช้ Encoder หรือระบบป้อนกลับใดๆ

**ฟีเจอร์สำคัญ:**
*   **Failsafe:** มอเตอร์จะหยุดทำงานหากสัญญาณจากรีโมทขาดหายเกิน 200ms
*   **Joystick Deadzone:** ป้องกันหุ่นยนต์ขยับเองเมื่อ Joystick ไม่ได้อยู่ตรงกลางสนิท
*   **ระบบเกียร์:** สามารถปรับความเร็วสูงสุดได้ 2 ระดับผ่านสวิตช์บนรีโมท

### 2. `SimpleFeedbackControlV3.ino` (ควบคุมแบบป้อนกลับอย่างง่าย)

เป็นเวอร์ชันที่เพิ่มการใช้ Encoder เข้ามาเพื่อรักษารอบการหมุนของล้อให้คงที่ตามคำสั่ง

**หลักการทำงาน:**
*   อ่านค่าจากรีโมทเพื่อกำหนด "ความเร็วเป้าหมาย" (Setpoint) ในหน่วย ticks/sec
*   อ่านค่าจาก Encoder เพื่อวัด "ความเร็วจริง" ของล้อ
*   นำค่าความผิดพลาด (Error) มาปรับแก้ค่า PWM อย่างต่อเนื่องเพื่อรักษารอบหมุน

**ฟีเจอร์สำคัญ:**
*   มีฟีเจอร์พื้นฐานทั้งหมดเหมือน `DirecControlV3.ino`
*   **Integral Reset:** แก้ปัญหา "ล้อไหล" โดยการรีเซ็ตค่า PWM ที่สะสมไว้เมื่อปล่อย Joystick หรือเมื่อ disarm
*   **Closed-loop Control:** ช่วยให้หุ่นยนต์เคลื่อนที่ด้วยความเร็วที่สม่ำเสมอมากขึ้น แม้เจอความต้านทานที่แตกต่างกัน

### 3. `PID_Control_V3.ino` (ควบคุมด้วย PID)

เป็นเวอร์ชันที่สมบูรณ์และมีเสถียรภาพสูงสุด โดยใช้ไลบรารี `PIDController` ในการคำนวณ

**หลักการทำงาน:**
*   ใช้หลักการเดียวกับ `SimpleFeedbackControlV3` แต่ใช้การคำนวณแบบ PID (Proportional-Integral-Derivative) ที่ซับซ้อนและแม่นยำกว่า
*   ปรับโครงสร้างโค้ดมาใช้ไลบรารี `PIDController` โดยเฉพาะ ทำให้โค้ดสะอาดและจัดการง่าย

**ฟีเจอร์สำคัญ:**
*   มีฟีเจอร์ทั้งหมดเหมือนเวอร์ชันก่อนหน้า
*   **PID Library:** ใช้ไลบรารีมาตรฐานในการควบคุม ทำให้สามารถจูนค่า Kp, Ki, Kd ได้ละเอียดกว่า
*   **Robust Reset:** ใช้ฟังก์ชัน `pid.reset()` เพื่อล้างสถานะของ PID Controller ทั้งหมด ทำให้การหยุดทำงานแม่นยำและป้องกันปัญหา Integral Windup ได้อย่างสมบูรณ์

## ไลบรารีที่จำเป็น

โปรเจกต์นี้ใช้ไลบรารีที่กำหนดเองซึ่งอยู่ในโปรเจกต์แล้ว:
*   `Encoder.h` / `.cpp`
*   `FlySkyi6Remote.h` / `.cpp`
*   `IBT2_MotorDriver.h` / `.cpp`
*   `PIDController.h` / `.cpp`

## การใช้งาน

1.  เลือกเฟิร์มแวร์ `.ino` ที่ต้องการจะใช้ (แนะนำให้เริ่มจาก `DirecControlV3.ino` เพื่อทดสอบฮาร์ดแวร์)
2.  ตรวจสอบการตั้งค่า Pinout ในไฟล์ `.ino` ให้ตรงกับฮาร์ดแวร์ที่เชื่อมต่อ
3.  หากใช้ระบบ Feedback (`SimpleFeedback` หรือ `PID`) ต้องแน่ใจว่าได้ต่อ Encoder และตั้งค่า Interrupt อย่างถูกต้อง
4.  อัปโหลดโค้ดลงในบอร์ดไมโครคอนโทรลเลอร์
5.  เปิดรีโมทและทดสอบการทำงาน